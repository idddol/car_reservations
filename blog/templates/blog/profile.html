{% extends 'blog/base.html' %}
{% block title %}–ü—Ä–æ—Ñ–∏–ª—å{% endblock %}

{% block content %}
<h2>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>

<div id="userInfo">
    <p><strong>–ò–º—è:</strong> <span id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>
    <p><strong>Email:</strong> <span id="userEmail">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>
</div>

<hr>

<h3>–ú–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:</h3>
<ul id="bookingList"><li>–ó–∞–≥—Ä—É–∑–∫–∞...</li></ul>

<h3>–ú–æ–∏ –ø–ª–∞—Ç–µ–∂–∏:</h3>
<ul id="paymentList"><li>–ó–∞–≥—Ä—É–∑–∫–∞...</li></ul>

<script>
const token = localStorage.getItem("access");

async function verifyToken() {
    if (!token) {
        window.location.href = "/api/site/login/";
        return false;
    }

    const res = await fetch("/api/token/verify/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token })
    });

    if (!res.ok) {
        localStorage.clear();
        window.location.href = "/api/site/login/";
        return false;
    }

    return true;
}

async function loadUser() {
    const res = await fetch("/api/users/me/", {
        headers: { "Authorization": `Bearer ${token}` }
    });

    const data = await res.json();
    document.getElementById("userName").innerText = data.name || "‚Äî";
    document.getElementById("userEmail").innerText = data.email || "‚Äî";
}

async function loadBookings() {
    const bookingRes = await fetch("/api/bookings/", {
        headers: { "Authorization": `Bearer ${token}` }
    });
    const paymentRes = await fetch("/api/payments/", {
        headers: { "Authorization": `Bearer ${token}` }
    });

    const bookings = await bookingRes.json();
    const payments = await paymentRes.json();

    const list = document.getElementById("bookingList");
    list.innerHTML = "";

    if (bookings.length === 0) {
        list.innerHTML = "<li>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –Ω–µ—Ç</li>";
    } else {
        bookings.forEach(b => {
            const payment = payments.find(p => p.booking == b.id);
            const isPaid = ["paid", "completed"].includes(payment?.payment_status);
            const paidStatus = isPaid ? "‚úÖ –æ–ø–ª–∞—á–µ–Ω–æ" : "‚ùå –Ω–µ –æ–ø–ª–∞—á–µ–Ω–æ";

            const item = document.createElement("li");
            item.innerHTML = `
                <strong>${b.car.brand} ${b.car.model}</strong><br>
                ${b.rental_start_date} ‚Üí ${b.rental_end_date}<br>
                –°—Ç–∞—Ç—É—Å –±—Ä–æ–Ω–∏: ${b.order_status}<br>
                –û–ø–ª–∞—Ç–∞: ${paidStatus}
                 ${!isPaid ? `<br><a href="/api/site/payment/${b.id}/">üí≥ –û–ø–ª–∞—Ç–∏—Ç—å</a>` : ""}
            `;
            list.appendChild(item);
        });
    }
}

async function loadPayments() {
    const res = await fetch("/api/payments/", {
        headers: { "Authorization": `Bearer ${token}` }
    });

    const data = await res.json();
    const list = document.getElementById("paymentList");
    list.innerHTML = "";

    if (data.length === 0) {
        list.innerHTML = "<li>–ü–ª–∞—Ç–µ–∂–µ–π –Ω–µ—Ç</li>";
    } else {
        data.forEach(p => {
            const item = document.createElement("li");
            item.innerText = `${p.amount}‚ÇΩ ‚Äî ${p.payment_method} ‚Äî ${p.payment_status}`;
            list.appendChild(item);
        });
    }
}

async function init() {
    const valid = await verifyToken();
    if (valid) {
        await loadUser();
        await loadBookings();
        await loadPayments();
    }
}

init();
</script>
{% endblock %}
