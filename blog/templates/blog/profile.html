{% extends 'blog/base.html' %}
{% block title %}–ü—Ä–æ—Ñ–∏–ª—å{% endblock %}

{% block content %}
<h2>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>

<div id="userInfo">
    <p><strong>–ò–º—è:</strong> <span id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>
    <p><strong>Email:</strong> <span id="userEmail">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>
</div>

<hr>

<h3>–ú–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:</h3>
<ul id="bookingList"><li>–ó–∞–≥—Ä—É–∑–∫–∞...</li></ul>

<h3>–ú–æ–∏ –ø–ª–∞—Ç–µ–∂–∏:</h3>
<ul id="paymentList"><li>–ó–∞–≥—Ä—É–∑–∫–∞...</li></ul>

<script>
async function refreshAccessToken() {
    const refresh = localStorage.getItem("refresh");
    if (!refresh) return false;

    const response = await fetch("/api/token/refresh/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ refresh })
    });

    if (response.ok) {
        const data = await response.json();
        localStorage.setItem("access", data.access);
        return true;
    } else {
        localStorage.clear();
        window.location.href = "/api/site/login/";
        return false;
    }
}

async function verifyToken() {
    const access = localStorage.getItem("access");
    if (!access) {
        window.location.href = "/api/site/login/";
        return false;
    }

    const res = await fetch("/api/token/verify/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token: access })
    });

    if (res.ok) {
        return true;
    } else {
        // access –∏—Å—Ç—ë–∫ ‚Äî –ø—Ä–æ–±—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å
        const refreshed = await refreshAccessToken();
        return refreshed;
    }
}

async function secureFetch(url, options = {}) {
    const access = localStorage.getItem("access");
    const opts = {
        ...options,
        headers: {
            ...options.headers,
            "Authorization": `Bearer ${access}`
        }
    };
    let res = await fetch(url, opts);

    if (res.status === 401) {
        const refreshed = await refreshAccessToken();
        if (refreshed) {
            const newAccess = localStorage.getItem("access");
            opts.headers["Authorization"] = `Bearer ${newAccess}`;
            res = await fetch(url, opts);
        } else {
            window.location.href = "/api/site/login/";
        }
    }

    return res;
}

async function loadUser() {
    const res = await secureFetch("/api/users/me/");
    const data = await res.json();
    document.getElementById("userName").innerText = data.name || "‚Äî";
    document.getElementById("userEmail").innerText = data.email || "‚Äî";
}

async function loadBookings() {
    const bookingRes = await secureFetch("/api/bookings/");
    const paymentRes = await secureFetch("/api/payments/");

    const bookings = await bookingRes.json();
    const payments = await paymentRes.json();

    const list = document.getElementById("bookingList");
    list.innerHTML = "";

    if (bookings.length === 0) {
        list.innerHTML = "<li>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –Ω–µ—Ç</li>";
    } else {
        bookings.forEach(b => {
            // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –ø–ª–∞—Ç–µ–∂–∏ –¥–ª—è —ç—Ç–æ–π –±—Ä–æ–Ω–∏
            const related = payments.filter(p => p.booking === b.id);
            const latestPayment = related.sort((a, b) => new Date(b.payment_date) - new Date(a.payment_date))[0];

            const isPaid = latestPayment?.payment_status === "completed";
            const payStatus = isPaid ? "‚úÖ –æ–ø–ª–∞—á–µ–Ω–æ" : "‚ùå –Ω–µ –æ–ø–ª–∞—á–µ–Ω–æ";
            const payLink = !isPaid ? `<br><a href="/api/site/payment/${b.id}/">üí≥ –û–ø–ª–∞—Ç–∏—Ç—å</a>` : "";

            const item = document.createElement("li");
            item.innerHTML = `
                <strong>${b.car.brand} ${b.car.model}</strong><br>
                ${b.rental_start_date} ‚Üí ${b.rental_end_date}<br>
                –°—Ç–∞—Ç—É—Å –±—Ä–æ–Ω–∏: ${b.order_status}<br>
                –û–ø–ª–∞—Ç–∞: ${payStatus}
                ${payLink}
                <br><button onclick="deleteBooking(${b.id})">üóë –£–¥–∞–ª–∏—Ç—å</button>
            `;
            list.appendChild(item);
        });
    }
}


async function loadPayments() {
    const res = await secureFetch("/api/payments/");
    const data = await res.json();

    const list = document.getElementById("paymentList");
    list.innerHTML = "";

    if (data.length === 0) {
        list.innerHTML = "<li>–ü–ª–∞—Ç–µ–∂–µ–π –Ω–µ—Ç</li>";
    } else {
        data.forEach(p => {
            const item = document.createElement("li");
            item.innerText = `${p.amount}‚ÇΩ ‚Äî ${p.payment_method} ‚Äî ${p.payment_status}`;
            list.appendChild(item);
        });
    }
}

async function deleteBooking(bookingId) {
    if (!confirm("–£–¥–∞–ª–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ?")) return;

    const res = await secureFetch(`/api/bookings/${bookingId}/`, {
        method: "DELETE"
    });

    if (res.ok) {
        alert("–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ");
        await loadBookings();
        await loadPayments();
    } else {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏");
    }
}

async function init() {
    const valid = await verifyToken();
    if (valid) {
        await loadUser();
        await loadBookings();
        await loadPayments();
    }
}

init();
</script>
{% endblock %}



