{% extends 'blog/base.html' %}
{% block title %}–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—à–∏–Ω—ã{% endblock %}

{% block content %}
<h2>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—à–∏–Ω—ã</h2>

<p><strong>–ú–∞—à–∏–Ω–∞:</strong> {{ car.brand }} {{ car.model }}</p>
<p><strong>–¶–µ–Ω–∞:</strong> {{ car.price }} ‚ÇΩ/–¥–µ–Ω—å</p>

<form id="bookingForm" data-car-id="{{ car.id }}">
    <label>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –∞—Ä–µ–Ω–¥—ã:
        <input type="date" id="start_date" required>
    </label>
    <br>
    <label>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞—Ä–µ–Ω–¥—ã:
        <input type="date" id="end_date" required>
    </label>
    <br><br>
    <button type="submit">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
    <p id="errorMessage" style="color:red;"></p>
</form>

<script>
async function refreshAccessToken() {
    const refresh = localStorage.getItem("refresh");
    if (!refresh) return false;

    const response = await fetch("/api/token/refresh/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ refresh })
    });

    if (response.ok) {
        const data = await response.json();
        localStorage.setItem("access", data.access);
        return true;
    } else {
        localStorage.clear();
        window.location.href = "/api/site/login/";
        return false;
    }
}

async function secureFetch(url, options = {}) {
    const access = localStorage.getItem("access");
    const opts = {
        ...options,
        headers: {
            ...options.headers,
            "Authorization": `Bearer ${access}`
        }
    };
    let res = await fetch(url, opts);

    if (res.status === 401) {
        const refreshed = await refreshAccessToken();
        if (refreshed) {
            const newAccess = localStorage.getItem("access");
            opts.headers["Authorization"] = `Bearer ${newAccess}`;
            res = await fetch(url, opts);
        } else {
            window.location.href = "/api/site/login/";
        }
    }

    return res;
}

document.getElementById("bookingForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const token = localStorage.getItem("access");
    const carId = document.getElementById("bookingForm").dataset.carId;
    const startDate = document.getElementById("start_date").value;
    const endDate = document.getElementById("end_date").value;
    const errorMessage = document.getElementById("errorMessage");

    if (!token) {
        window.location.href = "/api/site/login/";
        return;
    }
    const parsedCarId = parseInt(carId);
    console.log("ID –º–∞—à–∏–Ω—ã, –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π –≤ –∑–∞–ø—Ä–æ—Å:", parsedCarId);  // üëà –æ—Ç–ª–∞–¥–∫–∞

    const response = await secureFetch("/api/bookings/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({
            car: parseInt(carId),
            rental_start_date: startDate,
            rental_end_date: endDate
        })
    });


    if (response.ok) {
        const data = await response.json();
        window.location.href = `/api/site/payment/${data.id}/`;
    } else {
        try {
            const errorData = await response.json();
            console.error("–û—à–∏–±–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:", errorData);
            errorMessage.innerText = "–û—à–∏–±–∫–∞: " + JSON.stringify(errorData);
        } catch (e) {
            errorMessage.innerText = "–û—à–∏–±–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.";
        }
    }
});
</script>

{% endblock %}

