{% extends 'blog/base.html' %}
{% block title %}–ê–≤—Ç–æ–º–æ–±–∏–ª–∏{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<h2 class="mt-3">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h2>
<div class="mb-4">
    <button class="btn btn-outline-primary me-2" onclick="loadCars()">–í—Å–µ</button>
    <button class="btn btn-outline-primary me-2" onclick="loadCars(1)">üöó Economy</button>
    <button class="btn btn-outline-primary me-2" onclick="loadCars(2)">üíº Business</button>
    <button class="btn btn-outline-primary me-2" onclick="loadCars(3)">üíé Luxury</button>
    <button class="btn btn-outline-primary" onclick="loadCars(4)">üöô SUV</button>
</div>

<div class="row" id="carList">
    <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
</div>

<script>
async function refreshAccessToken() {
    const refresh = localStorage.getItem("refresh");
    if (!refresh) return false;

    const res = await fetch("/api/token/refresh/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ refresh })
    });

    if (res.ok) {
        const data = await res.json();
        localStorage.setItem("access", data.access);
        return true;
    } else {
        localStorage.clear();
        window.location.href = "/api/site/login/";
        return false;
    }
}

async function secureFetch(url, options = {}) {
    const access = localStorage.getItem("access");
    const opts = {
        ...options,
        headers: {
            ...options.headers,
            "Authorization": `Bearer ${access}`
        }
    };
    let res = await fetch(url, opts);

    if (res.status === 401) {
        const refreshed = await refreshAccessToken();
        if (refreshed) {
            const newAccess = localStorage.getItem("access");
            opts.headers["Authorization"] = `Bearer ${newAccess}`;
            res = await fetch(url, opts);
        } else {
            window.location.href = "/api/site/login/";
        }
    }

    return res;
}

async function loadCars(categoryId = null) {
    const res = await secureFetch("/api/cars/");
    const carList = document.getElementById("carList");
    carList.innerHTML = "";

    if (!res.ok) {
        carList.innerHTML = "<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—à–∏–Ω</p>";
        return;
    }

    const data = await res.json();
    const isAdmin = localStorage.getItem("is_staff") === "true";
    const filtered = categoryId ? data.filter(car => car.categories.includes(categoryId)) : data;

    if (filtered.length === 0) {
        carList.innerHTML = "<p>–ù–µ—Ç –º–∞—à–∏–Ω –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.</p>";
        return;
    }

    filtered.forEach(car => {
        const col = document.createElement("div");
        col.className = "col-md-4 mb-4";

        const images = car.images.length > 0
            ? car.images.map((img, i) => `
                <div class="carousel-item ${i === 0 ? 'active' : ''}">
                    <img src="${img.image_url}" class="d-block w-100" alt="Car image ${i + 1}">
                </div>
              `).join('')
            : `<div class="carousel-item active"><img src="https://via.placeholder.com/400x200?text=${car.brand}+${car.model}" class="d-block w-100" alt="Placeholder"></div>`;

        const carouselId = `carousel-${car.id}`;

        col.innerHTML = `
            <div class="card shadow-sm h-100">
                <div id="${carouselId}" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-inner">${images}</div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#${carouselId}" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon"></span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#${carouselId}" data-bs-slide="next">
                        <span class="carousel-control-next-icon"></span>
                    </button>
                </div>
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">${car.brand} ${car.model}</h5>
                    <p class="card-text">
                        –ì–æ–¥: ${car.year_of_release}<br>
                        –¶–µ–Ω–∞: <strong>${car.price}‚ÇΩ/–¥–µ–Ω—å</strong>
                    </p>
                    <a href="/api/site/booking/${car.id}/" class="btn btn-primary mt-auto">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</a>
                    ${isAdmin ? `
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-secondary mb-1" onclick="toggleImageInput(${car.id})">üìé –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</button>
                            <div id="input-container-${car.id}" style="display: none;">
                                <input type="text" id="url-${car.id}" class="form-control form-control-sm mb-1" placeholder="https://example.com/car.jpg">
                                <button class="btn btn-sm btn-success" onclick="submitImageUrl(${car.id})">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
        carList.appendChild(col);
    });
}

function toggleImageInput(carId) {
    const container = document.getElementById(`input-container-${carId}`);
    container.style.display = container.style.display === "none" ? "block" : "none";
}

async function submitImageUrl(carId) {
    const url = document.getElementById(`url-${carId}`).value.trim();
    if (!url) {
        alert("–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ");
        return;
    }

    const res = await secureFetch("/api/car-images/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            car: carId,
            image_url: url
        })
    });

    if (res.ok) {
        alert("–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ!");
        loadCars();  // –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫
    } else {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è");
    }
}

loadCars();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
